name: Version Consistency Check

on:
  push:
    branches: [main]
    paths:
      - 'lua/core/version.lua'
      - 'README.md'
      - 'CHANGELOG.md'
      - '.github/project-info.json'
      - 'docs/ARCHITECTURE.md'
      - 'docs/ARCHITECTURE-DETAILS.md'
      - 'THIRD-PARTY-LICENSES.md'
  pull_request:
    branches: [main]
    paths:
      - 'lua/core/version.lua'
      - 'README.md'
      - 'CHANGELOG.md'
      - '.github/project-info.json'
      - 'docs/ARCHITECTURE.md'
      - 'docs/ARCHITECTURE-DETAILS.md'
      - 'THIRD-PARTY-LICENSES.md'

jobs:
  check-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from version.lua
        id: version_lua
        run: |
          VERSION=$(grep -oP 'M\.config_version = "\K[^"]+' lua/core/version.lua)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version aus version.lua: $VERSION"

      - name: Check README.md version
        run: |
          EXPECTED="${{ steps.version_lua.outputs.version }}"

          # Check "NEW in Modern LSP Performance Edition" header
          if ! grep -q "NEW in Modern LSP Performance Edition (v$EXPECTED)" README.md; then
            echo "âŒ FEHLER: README.md enthÃ¤lt nicht 'NEW in Modern LSP Performance Edition (v$EXPECTED)'"
            echo "Gefunden:"
            grep "NEW in Modern LSP Performance Edition" README.md || echo "  Keine passende Zeile gefunden"
            exit 1
          fi

          echo "âœ… README.md Version korrekt: v$EXPECTED"

      - name: Check project-info.json version
        run: |
          EXPECTED="${{ steps.version_lua.outputs.version }}"
          JSON_VERSION=$(grep -oP '"version": "\K[^"]+' .github/project-info.json)

          if [ "$JSON_VERSION" != "$EXPECTED" ]; then
            echo "âŒ FEHLER: project-info.json Version '$JSON_VERSION' â‰  '$EXPECTED'"
            exit 1
          fi

          echo "âœ… project-info.json Version korrekt: $EXPECTED"

      - name: Check CHANGELOG.md version
        run: |
          EXPECTED="${{ steps.version_lua.outputs.version }}"

          # Check if version exists in changelog (format: "## v1.0.1")
          if ! grep -q "^## v$EXPECTED " CHANGELOG.md; then
            echo "âš ï¸ WARNUNG: CHANGELOG.md enthÃ¤lt keinen Eintrag fÃ¼r v$EXPECTED"
            echo "Gefundene Versionen:"
            grep "^## v" CHANGELOG.md | head -5
            echo ""
            echo "Dies ist nur eine Warnung - Changelog wird mÃ¶glicherweise nach Release aktualisiert"
          else
            echo "âœ… CHANGELOG.md Version gefunden: v$EXPECTED"
          fi

      - name: Check ARCHITECTURE.md version
        run: |
          EXPECTED="${{ steps.version_lua.outputs.version }}"

          if ! grep -q "Current Version: $EXPECTED" docs/ARCHITECTURE.md; then
            echo "âŒ FEHLER: ARCHITECTURE.md enthÃ¤lt nicht 'Current Version: $EXPECTED'"
            echo "Gefunden:"
            grep "Current Version:" docs/ARCHITECTURE.md || echo "  Keine 'Current Version' Zeile gefunden"
            exit 1
          fi

          echo "âœ… ARCHITECTURE.md Version korrekt: $EXPECTED"

      - name: Check ARCHITECTURE-DETAILS.md version
        run: |
          EXPECTED="${{ steps.version_lua.outputs.version }}"

          if ! grep -q "Current Version: $EXPECTED" docs/ARCHITECTURE-DETAILS.md; then
            echo "âŒ FEHLER: ARCHITECTURE-DETAILS.md enthÃ¤lt nicht 'Current Version: $EXPECTED'"
            echo "Gefunden:"
            grep "Current Version:" docs/ARCHITECTURE-DETAILS.md || echo "  Keine 'Current Version' Zeile gefunden"
            exit 1
          fi

          echo "âœ… ARCHITECTURE-DETAILS.md Version korrekt: $EXPECTED"

      - name: Check THIRD-PARTY-LICENSES.md version
        run: |
          EXPECTED="${{ steps.version_lua.outputs.version }}"

          if ! grep -q "VelocityNvim Version.*: $EXPECTED" THIRD-PARTY-LICENSES.md; then
            echo "âŒ FEHLER: THIRD-PARTY-LICENSES.md enthÃ¤lt nicht 'VelocityNvim Version: $EXPECTED'"
            echo "Gefunden:"
            grep "VelocityNvim Version" THIRD-PARTY-LICENSES.md || echo "  Keine Version-Zeile gefunden"
            exit 1
          fi

          echo "âœ… THIRD-PARTY-LICENSES.md Version korrekt: $EXPECTED"

      - name: Version Consistency Summary
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ALLE VERSION-CHECKS ERFOLGREICH"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Version: ${{ steps.version_lua.outputs.version }}"
          echo ""
          echo "ÃœberprÃ¼fte Dateien:"
          echo "  âœ… lua/core/version.lua (Quelle)"
          echo "  âœ… README.md"
          echo "  âœ… .github/project-info.json"
          echo "  âœ… CHANGELOG.md (Warnung bei fehlender Version)"
          echo "  âœ… docs/ARCHITECTURE.md"
          echo "  âœ… docs/ARCHITECTURE-DETAILS.md"
          echo "  âœ… THIRD-PARTY-LICENSES.md"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
